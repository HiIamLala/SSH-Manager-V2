document.addEventListener("DOMContentLoaded", function () {
    if(window.localStorage.getItem("Auth")){
        window.location.replace("index.html");
    }
    $("#login-butt").on("click", function () {
        event.preventDefault();
        login();
    });

    $("#exampleInputEmail").on("keypress", function(e) {
        if (e.keyCode == 13) {
            login();
        }
    });
    $("#exampleInputPassword").on("keypress", function(e) {
        if (e.keyCode == 13) {
            login();
        }
    });
    $('#new-password').on("keypress", function(e) {
        if (e.keyCode == 13) {
            var password = $('#new-password').val();
            if($('#new-password').val()==""&&$('#confirm-new-password').val()==""){
                $('#challenge-notification').html("You have to fill both fields");
            }
            else if($('#new-password').val()!=$('#confirm-new-password').val()){
                $('#challenge-notification').html("Password mismatch");
            }
            else{
                var data = JSON.stringify({
                    "ChallengeName": "NEW_PASSWORD_REQUIRED",
                    "Session": session,
                    "Username": username,
                    "NewPassword": $('#new-password').val()
                });
                var xhttp = new XMLHttpRequest();
                xhttp.onloadend = function(){
                    if(this.status == 200 && JSON.parse(this.responseText).statusCode == 200){
                        var auth = JSON.parse(this.responseText).body.AuthenticationResult;
                        auth.timeAcquired = new Date().getTime();
                        window.localStorage.setItem('Auth',JSON.stringify(auth));
                        window.location.replace("index.html");
                    }
                    else if(JSON.parse(this.responseText).errorType){
                        $('#challenge-notification').html(JSON.parse(this.responseText).errorMessage);
                    }
                    else{
                        console.log(this);
                    }
                }
                xhttp.open("POST","https://v7gmuisen3.execute-api.ap-southeast-1.amazonaws.com/beta/challengerep",true);
                xhttp.setRequestHeader("Content-Type","application/json");
                xhttp.send(data);
            }
        }
    });
    $('#confirm-new-password').on("keypress", function(e) {
        if (e.keyCode == 13) {
            var password = $('#new-password').val();
            if($('#new-password').val()==""&&$('#confirm-new-password').val()==""){
                $('#challenge-notification').html("You have to fill both fields");
            }
            else if($('#new-password').val()!=$('#confirm-new-password').val()){
                $('#challenge-notification').html("Password mismatch");
            }
            else{
                var data = JSON.stringify({
                    "ChallengeName": "NEW_PASSWORD_REQUIRED",
                    "Session": session,
                    "Username": username,
                    "NewPassword": $('#new-password').val()
                });
                var xhttp = new XMLHttpRequest();
                xhttp.onloadend = function(){
                    if(this.status == 200 && JSON.parse(this.responseText).statusCode == 200){
                        var auth = JSON.parse(this.responseText).body.AuthenticationResult;
                        auth.timeAcquired = new Date().getTime();
                        window.localStorage.setItem('Auth',JSON.stringify(auth));
                        window.location.replace("index.html");
                    }
                    else if(JSON.parse(this.responseText).errorType){
                        $('#challenge-notification').html(JSON.parse(this.responseText).errorMessage);
                    }
                    else{
                        console.log(this);
                    }
                }
                xhttp.open("POST","https://v7gmuisen3.execute-api.ap-southeast-1.amazonaws.com/beta/challengerep",true);
                xhttp.setRequestHeader("Content-Type","application/json");
                xhttp.send(data);
            }
        }
    });
});

function login(){
    $("#notification").empty();
    var username = $("#exampleInputEmail").val();
    var password = $("#exampleInputPassword").val();

    if(username&&password){
        $('#loader').fadeIn(200);
        var xhttp = new XMLHttpRequest();
        var data = JSON.stringify({"username":username,"password":password});
        xhttp.onloadend = function () {
            $('#loader').fadeOut(200);
            if (this.status == 200) {
                var result = JSON.parse(this.responseText);
                if(result.errorType){
                    $("#notification").html(result.errorMessage);
                }
                else if(JSON.parse(this.responseText).statusCode == 200 && JSON.parse(this.responseText).body.AuthenticationResult){
                    var auth = result.body.AuthenticationResult;
                    auth.timeAcquired = new Date().getTime();
                    window.localStorage.setItem('Auth',JSON.stringify(auth));
                    window.location.replace("index.html");
                }
                else if(JSON.parse(this.responseText).body.ChallengeName == "NEW_PASSWORD_REQUIRED"){
                    var session = JSON.parse(this.responseText).body.Session;
                    var username = JSON.parse(this.responseText).body.ChallengeParameters.USER_ID_FOR_SRP;
                    $('#login').fadeOut(250,()=>{$('#challenge-rep').fadeIn(250)});
                    $('#greeting').html("Hello "+ username);
                    $('#challenge-detail').html("You have to change your password on first login");
                    $('#challenge-rep-butt').unbind();
                    $('#challenge-rep-butt').on('click',function(){
                        var password = $('#new-password').val();
                        if($('#new-password').val()==""&&$('#confirm-new-password').val()==""){
                            $('#challenge-notification').html("You have to fill both fields");
                        }
                        else if($('#new-password').val()!=$('#confirm-new-password').val()){
                            $('#challenge-notification').html("Password mismatch");
                        }
                        else{
                            var data = JSON.stringify({
                                "ChallengeName": "NEW_PASSWORD_REQUIRED",
                                "Session": session,
                                "Username": username,
                                "NewPassword": $('#new-password').val()
                            });
                            var xhttp = new XMLHttpRequest();
                            xhttp.onloadend = function(){
                                if(this.status == 200 && JSON.parse(this.responseText).statusCode == 200){
                                    var auth = JSON.parse(this.responseText).body.AuthenticationResult;
                                    auth.timeAcquired = new Date().getTime();
                                    window.localStorage.setItem('Auth',JSON.stringify(auth));
                                    window.location.replace("index.html");
                                }
                                else if(JSON.parse(this.responseText).errorType){
                                    $('#challenge-notification').html(JSON.parse(this.responseText).errorMessage);
                                }
                                else{
                                    console.log(this);
                                }
                            }
                            xhttp.open("POST","https://v7gmuisen3.execute-api.ap-southeast-1.amazonaws.com/beta/challengerep",true);
                            xhttp.setRequestHeader("Content-Type","application/json");
                            xhttp.send(data);
                        }
                    });
                }
            }
            else if(this.status == 500){
                $("#notification").html("Server drown... ax ax blob blob");
            }
            else{
                $("#notification").html("Wrong username or password");
            }
        }
        xhttp.open("POST", "https://v7gmuisen3.execute-api.ap-southeast-1.amazonaws.com/beta/login", true);
        xhttp.setRequestHeader("Content-Type","application/json");
        xhttp.send(data);
    }
}